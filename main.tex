\input{style.tex}

\begin{document}

%%
%% begin titlepage
%%

\begin{titlepage}
\newgeometry{left=6cm}
\definecolor{titlepage-color}{HTML}{2196F3}
\newpagecolor{titlepage-color}\afterpage{\restorepagecolor}
\newcommand{\colorRule}[3][black]{\textcolor[HTML]{#1}{\rule{#2}{#3}}}
\begin{flushleft}
\noindent
\\[-1em]
\color[HTML]{FFFFFF}
\makebox[0pt][l]{\colorRule[1976D2]{1.3\textwidth}{8pt}}
\par
\noindent

{ \setstretch{1.4}
\vfill
\noindent {\huge \textbf{\textsf{The Raft Consensus Algorithm}}}
\vskip 2em
\noindent
{\Large \textsf{\MakeUppercase{Fabio Anderegg}}
\vfill
}

\textsf{2017-12-04}}
\end{flushleft}
\end{titlepage}
\restoregeometry

%%
%% end titlepage
%%


{
\hypersetup{linkcolor=}
\setcounter{tocdepth}{3}
\tableofcontents
\pagebreak
}

\section{Abstract}
What is in this paper?
\begin{itemize}
    \item What is consensus?
    \item Describtion of the algorithm
    \item how the algorithm behaves (and sometimes fails) in specific scenarios
    \item short description of my implementation of raft
\end{itemize}

\section{Introduction}

\includegraphics[scale=0.05]{raft}

This paper covers Raft, a consensus algorithm for distributed systems.

Raft wants to be a simpler replacement for PAXOS, an algorithm developed by Leslie Lamport and considered the reference consensus algorithm for distributed systems[CN]. PAXOS suffers from two big problems, which Raft tries to solve: It is very hard to understand [CN] and it has some missing pieces to actually implement a real world system using PAXOS [CN (Chubby?)].

Raft was developed by Diego Ongaro and extensively described in this PhD thesis [CN]. He not only describes how the algorithm works, but also did a study under students to test if the algorithm is actually easier to understand than PAXOS. Raft has been formally verified to be correct [CN] and implemented in multiple real world systems, e.g. in etcd [CN], Consul [CN] and RethinkDB [CN].

The offical GitHub Page [https://raft.github.io/] contains many further references about the algorithm, a simulator for the algorithm from which screenshots have been used in this paper and an extensive list of implementations in many different programming languages.

TODO: rework
This paper has four parts: The first part explains what consensus in a distributed system is and how it is used, the second part explains how the Raft algorithm works, the third part shows how Raft handles some failure modes. To validate the claim that Raft is easy to implement, the author of this paper tried to implement a simple key/value store using Raft, which is described in the fourth part.

\subsection{What is consensus?}

Discuss the consensus problem for distributed systems.
Consensus: getting a number of machines to agree on a specific value or outcome.

Problem: Hosts and networks can stop working, be slow or have other failures.

\subsection{The CAP Theorem}

The CAP theorem describe how certain failures in a distributed system affects the system. It states that a distributed system can never provide more than two of the following guarantees:

\begin{itemize}
    \item Consistency: TODO
    \item Availability: TODO
    \item Partition tolerance: TODO
\end{itemize}

Raft is a CP algorithm, that means systems using this algorithm are tolerant to partitions and always provide consistency by sacrificing availability. 

\section{The algorithm}
A Raft cluster consists of nodes. A node is a server running the Raft software and communicating with the other nodes in the cluster over a network connection.
In every cluster, one node is elected as a leader node, which coordinates the operations inside the cluster. A leader can only be elected by
a majority of the cluster nodes. This means the minimal cluster size is three nodes, and bigger clusters should always have an uneven count of nodes (In a cluster
of six nodes, two nodes can crash and a majority can still be found, this is not better than a five node cluster).
This also means that when more than half of the cluster nodes are offline, the cluster is inoperable. This is availability guarantee of the CAP theorem the Raft algorithm gives up
for the other two guarantees. 

* has a log with data

The Raft algorithm is designed to survive the following and many other failure cases:
item\begin{itemize}
    \item The current leader crashes
    \item Network connections between nodes fail
    \item Network connections are very slow or drop messages between nodes
\end{itemize}

\subsection{State}
Every node in the Raft cluster is always in one of the following three states:
\begin{itemize}
    \item Leader: The node is the leader of the cluster
    \item Candidate: The node did not find a leader, it is waiting to get enough votes to be a leader itself
    \item Follower: Some other node is a leader
\end{itemize}

\subsection{RPC}

2 Messages with 2 Answers

\subsection{Timers}

Distributed state diagram

\section{Scenarios}
This section takes a look on different scenarios and failure modes in the cluster and how Raft handles these cases.

\subsection{Leader election}

\subsection{Heartbeat}

\subsection{Data write}
Writing data into the cluster uses the same message as the heartbeat.


\subsection{Master crash}
A master crash is handled like the initial leader election, the election timeout runs out on one of the servers, the server ...

\subsection{Delayed packages}
=> Wait until enough packages arrive, this is a CP algorithm after all

\subsection{Network partition}

\subsection{Old follower returns}


\subsection{Old master returns}
=> Steps down as soon as they see a heartbeat packet from the current master with a newer term.
The node is a follower now and does the same as in the section above to regain all the missing data.

\subsection{Switching masters in network partition}
When connection between two nodes fail, a ping-pong between these two nodes *can* happen.

http://openlife.cc/system/files/4-modifications-for-Raft-consensus.pdf

\subsection{Inconsistens reads}
https://github.com/coreos/etcd/issues/741

\subsection{Cheat sheet}
Like in the original raft paper, but with much more information (flow-diagram or pseudo code)

\section {Implementation}

The author of this paper implemented the algorithm to check the premise of a simple and easy to implement consensus algorithm. The implemented solution is a very simple key-value store, as described in the raft paper. The implementation is written in C++ and uses the Boost library for network communication and other utility functions, Protobuf to serialize the network packages between the node and the client and cereal to decode the json config file for each node.

The code is available on GitHub and uses the MIT license: https://github.com/fotcorn/raft

\subsection{Learnings}

\subsection{Additions}
Client?

\section{Conclusion}
Refernces the abstract

\end{document}
